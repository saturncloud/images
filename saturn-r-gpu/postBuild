# https://cran.rstudio.com/bin/linux/debian/


sudo apt update
sudo apt install -y \
    --no-install-recommends \
        software-properties-common

wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | sudo tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc

sudo su -c \
    "echo 'deb https://cloud.r-project.org/bin/linux/ubuntu bionic-cran40/' >>/etc/apt/sources.list"

sudo apt update
sudo apt install -y -t bionic-cran40 \
    r-base \
    r-base-core \
    r-base-dev \
    r-recommended

sudo apt install -y \
    jupyter-client \
    devscripts \
    libxml2 \
    libxml2-dev \
    libcurl4-openssl-dev \
    libssl-dev \
    libzmq3-dev \
    qpdf

RUN sudo chown 1000:1000 -R /usr/local/lib/R \
    && sudo chmod 777 -R /usr/local/lib/R \
    && sudo chown 1000:1000 -R /usr/lib/R \
    && sudo chmod 777 -R /usr/lib/R 

# install other packages
sudo Rscript -e "install.packages(c( \
        'data.table', \
        'devtools', \
        'dplyr', \
        'ggplot2', \
        'IRkernel', \
        'lubridate', \
        'Rcpp', \
        'readr', \
        'remotes', \
        'reticulate', \
        'stringr', \
        'tidyr', \
        'forcats', \
        'tidyverse', \
        'tensorflow', \
        'keras', \
        'torch' \
    ), Ncpus = max(c(1, parallel::detectCores() - 1)), \
    dependencies = c('LinkingTo', 'Depends', 'Imports') \
    )"

# Set up R kernel for Jupyter
sudo Rscript -e "IRkernel::installspec(user = FALSE)"

# Setup R reticulate for Python
sudo su -c "echo 'RETICULATE_PYTHON=/opt/conda/envs/saturn/bin/python' >> /usr/lib/R/etc/Renviron"

# Add required python packages
/opt/conda/envs/saturn/bin/python -m pip install tensorflow